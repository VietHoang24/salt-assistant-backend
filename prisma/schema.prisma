generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id                 String               @id @default(uuid())
  email              String?              @unique
  google_id          String?              @unique
  full_name          String?
  avatar_url         String?
  telegram_chat_id   String?
  timezone           String?
  created_at         DateTime             @default(now())
  updated_at         DateTime             @updatedAt
  notification_logs  notification_logs[]
  user_categories    user_categories[]
  user_configs       user_configs?
  user_daily_summary user_daily_summary[]
  user_goal_logs     user_goal_logs[]
  user_goals         user_goals[]
}

model user_configs {
  id            String    @id @default(uuid())
  user_id       String    @unique
  morning_time  DateTime? @db.Time(6)
  evening_time  DateTime? @db.Time(6)
  funfact_time  DateTime? @db.Time(6)
  summary_style String?
  enable_notif  Boolean?
  created_at    DateTime  @db.Timestamptz(6)
  updated_at    DateTime  @db.Timestamptz(6)
  user          users     @relation(fields: [user_id], references: [id])
}

model categories {
  id              String            @id @default(uuid())
  name            String
  slug            String            @unique
  is_default      Boolean
  created_at      DateTime          @db.Timestamptz(6)
  news            news[]
  user_categories user_categories[]
}

model user_categories {
  id          String     @id @default(uuid())
  user_id     String
  category_id String
  created_at  DateTime   @db.Timestamptz(6)
  category    categories @relation(fields: [category_id], references: [id])
  user        users      @relation(fields: [user_id], references: [id])
}

model user_goals {
  id          String           @id @default(uuid())
  user_id     String
  title       String
  description String?
  created_at  DateTime         @db.Timestamptz(6)
  updated_at  DateTime         @db.Timestamptz(6)
  end_date    DateTime         @db.Timestamptz(6)
  start_date  DateTime         @db.Timestamptz(6)
  type        GoalType
  logs        user_goal_logs[]
  user        users            @relation(fields: [user_id], references: [id])
}

model user_goal_logs {
  id          String     @id @default(uuid())
  user_id     String
  goal_id     String
  progress    Decimal?   @db.Decimal
  log_message String?
  created_at  DateTime   @db.Timestamptz(6)
  goal        user_goals @relation(fields: [goal_id], references: [id])
  user        users      @relation(fields: [user_id], references: [id])
}

model news {
  id           String      @id @default(uuid())
  source       String
  title        String
  content      String?
  url          String?
  category_id  String?
  published_at DateTime?   @db.Timestamptz(6)
  created_at   DateTime    @db.Timestamptz(6)
  category     categories? @relation(fields: [category_id], references: [id])
}

model market_data {
  id           String   @id @default(uuid())
  gold_price   Decimal? @db.Decimal
  btc_price    Decimal? @db.Decimal
  eth_price    Decimal? @db.Decimal
  usd_vnd_rate Decimal? @db.Decimal
  created_at   DateTime @db.Timestamptz(6)
}

model ai_daily_summary {
  id            String   @id @default(uuid())
  date          DateTime @unique @db.Date
  summary_text  String?
  macro_events  Json?
  risks         Json?
  opportunities Json?
  created_at    DateTime @db.Timestamptz(6)
}

model user_daily_summary {
  id             String    @id @default(uuid())
  user_id        String
  date           DateTime  @db.Date
  summary_text   String?
  raw_ai_summary String?
  user_custom    Json?
  sent_at        DateTime? @db.Timestamptz(6)
  created_at     DateTime  @db.Timestamptz(6)
  user           users     @relation(fields: [user_id], references: [id])
}

model notification_logs {
  id         String    @id @default(uuid())
  user_id    String
  channel    String
  type       String
  content    String?
  status     String
  sent_at    DateTime? @db.Timestamptz(6)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  user       users     @relation(fields: [user_id], references: [id])
}

model error_logs {
  id            String   @id @default(uuid())
  service       String
  error_message String
  data_snapshot Json?
  created_at    DateTime @db.Timestamptz(6)
}

model cycles {
  id                  String                @id @default(uuid())
  type                String                @default("daily")
  status              String
  note                String?
  started_at          DateTime              @default(now())
  finished_at         DateTime?
  ai_context_analysis ai_context_analysis[]
  intelligence        intelligence[]
  normalized          normalized_data[]
  raw_data            raw_data[]
  signals             signals[]

  @@index([status])
}

model raw_data {
  id         String            @id @default(uuid())
  cycle_id   String
  source     String
  data_type  String
  asset_hint String?
  payload    Json
  checksum   String?
  fetched_at DateTime          @default(now())
  normalized normalized_data[]
  cycle      cycles            @relation(fields: [cycle_id], references: [id])

  @@index([cycle_id])
  @@index([source])
  @@index([data_type])
}

model normalized_data {
  id                String   @id @default(uuid())
  cycle_id          String
  asset_code        String
  asset_type        String
  value             Decimal?
  unit              String?
  effective_at      DateTime
  source            String?
  normalize_version String
  raw_id            String
  cycle             cycles   @relation(fields: [cycle_id], references: [id])
  raw               raw_data @relation(fields: [raw_id], references: [id])

  @@index([asset_code, effective_at])
  @@index([cycle_id])
}

model signals {
  id           String         @id @default(uuid())
  cycle_id     String
  signal_type  String
  asset_code   String?
  direction    String?
  strength     Int?
  detected_at  DateTime       @default(now())
  based_on_ids String[]
  note         String?
  cycle        cycles         @relation(fields: [cycle_id], references: [id])
  intelligence intelligence[] @relation("SignalToIntelligence")

  @@index([cycle_id])
  @@index([signal_type])
}

model intelligence {
  id            String          @id @default(uuid())
  cycle_id      String
  context       String
  confidence    Decimal?
  horizon       String?
  summary       String
  signal_refs   String[]
  created_at    DateTime        @default(now())
  cycle         cycles          @relation(fields: [cycle_id], references: [id])
  notifications notifications[]
  signals       signals[]       @relation("SignalToIntelligence")

  @@index([context])
  @@index([cycle_id])
}

model notifications {
  id              String       @id @default(uuid())
  intelligence_id String
  channel         String
  receiver        String
  status          String
  error           String?
  sent_at         DateTime?
  intelligence    intelligence @relation(fields: [intelligence_id], references: [id])
}

model ai_context_analysis {
  id             String   @id @default(uuid())
  cycle_id       String
  input_snapshot Json
  output         Json
  model          String
  confidence     Decimal?
  created_at     DateTime @default(now())
  cycle          cycles   @relation(fields: [cycle_id], references: [id])
}

enum GoalType {
  yearly
  monthly
  weekly
}
